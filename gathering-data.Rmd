---
title: "gathering-data"
author: "Alexander Park"
date: "10/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(rstanarm)
require("knitr")
opts_knit$set(root.dir = "~/Desktop/GOV_50/home-field-advantage/shiny-app")
```

# NFL

```{r nfl}

# Create object nfl_scores_1966 that has all scores from NFL games from 1966-67
# to 2019-2020.

nfl_scores_1966 <- read_csv("data/nflscores1966/spreadspoke_scores.csv")

# Create object avg_nfl_home_score that is the average score that home teams
# have had over the years. Save to RDS.

avg_nfl_home_score <- nfl_scores_1966 %>%
  group_by(team_home) %>%
  summarize(avg_home = mean(score_home), .groups = "drop")

saveRDS(avg_nfl_home_score, file = "nfl_avg_home_scores")

ggplot(avg_nfl_home_score, aes(team_home, avg_home)) + 
        geom_col(color = "white", fill = "dodgerblue") +
        theme(axis.text.x = element_text(angle = 90, 
                                         vjust = 0.5, 
                                         hjust = 0.3)) +
  labs(title = "Average Home Scores for All NFL Teams",
       subtitle = "From 1966-67 to 2019-20",
       x = "Team",
       y = "Average Home Score")



```

# NBA

```{r nba}

# Create object nba_names_2004 to organize NBA team names.

nba_names_2004 <- read_csv("data/nba2004/teams.csv") %>%
  clean_names()

nba_names_2004 <- nba_names_2004 %>%
  select(city, nickname, team_id) %>%
  unite(name, c("city", "nickname"), sep = " ")

# Create object nba_scores_2004 that has all scores from NFL games from 2004
# to March 2020.

nba_scores_2004 <- read_csv("data/nba2004/games.csv") %>%
  clean_names() %>%
  rename(team_id = home_team_id) %>%
  select(team_id, visitor_team_id, season, pts_home, pts_away)

nba_scores_2004 <- left_join(nba_scores_2004, nba_names_2004, by = "team_id") %>%
  rename(home_team = name)

nba_names_2004_away <- nba_names_2004 %>%
  rename(visitor_team_id = team_id)
  
nba_scores_2004 <- left_join(nba_scores_2004, 
                             nba_names_2004_away, 
                             by = "visitor_team_id") %>%
  rename(away_team = name) %>%
  select(home_team, away_team, season, pts_home, pts_away)

# Create object avg_nba_home_score that is the average score that home teams
# have had over the years. Save to RDS.

avg_nba_home_score <- nba_scores_2004 %>%
  select(home_team, pts_home) %>%
  group_by(home_team) %>%
  summarize(avg_home = mean(pts_home, na.rm = TRUE), .groups = "drop")

saveRDS(avg_nba_home_score, file = "nba_avg_home_scores")

ggplot(avg_nba_home_score, aes(home_team, avg_home)) + 
        geom_col(color = "white", fill = "dodgerblue") +
        theme(axis.text.x = element_text(angle = 90, 
                                         vjust = 0.5, 
                                         hjust = 0.3)) +
  labs(title = "Average Home Scores for All NBA Teams",
       subtitle = "From 2004 to Feb. 2020",
       x = "Team",
       y = "Average Home Score")

```

# MLB

```{r mlb}

# Create object mlb_scores_1947 that has all scores from MLB games from 1947 (when the MLB became racially integrated) to October 2019.

# Create object mlb_names_1947 to organize MLB team names.

mlb_scores_1947 <- read_csv("data/mlbscores/mlb_elo.csv") %>%
  clean_names() %>%
  rename(home_team = team1,
         away_team = team2,
         home_score = score1,
         away_score = score2) %>%
  filter(season >= 1947) %>%
  filter(season != 2020)

# Create object avg_mlb_home_score that is the average score that home teams
# have had over the years. Save to RDS.

avg_mlb_home_score <- mlb_scores_1947 %>%
  select(home_team, home_score) %>%
  group_by(home_team) %>%
  summarize(avg_home = mean(home_score, na.rm = TRUE), .groups = "drop")

saveRDS(avg_mlb_home_score, file = "mlb_avg_home_scores")

ggplot(avg_mlb_home_score, aes(home_team, avg_home)) +
        geom_col(color = "white", fill = "dodgerblue") + 
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   hjust = 0.3)) +
  scale_x_discrete(labels = c("Anaheim Angels", "Arizona Diamondbacks", 
                              "Atlanta Braves", "Baltimore Orioles",
                              "Boston Red Sox", "Chicago Cubs",
                              "Chicago White Sox", "Cincinnati Reds",
                              "Cleveland Indians", "Colorado Rockies",
                              "Detroit Tigers", "Miami Marlins",
                              "Houston Astros", "Kansas City Royals",
                              "Los Angeles Dodgers", "Milwaukee Brewers",
                              "Minnesota Twins", "New York Mets",
                              "New York Yankees", "Oakland Athletics",
                              "Philadelphia Phillies", "Pittsburgh Pirates",
                              "San Diego Padres", "Seattle Mariners",
                              "San Francisco Giants", "St Louis Cardinals",
                              "Tampa Bay Rays", "Texas Rangers",
                              "Toronto Blue Jays", "Washington Nationals")) +
  labs(title = "Average Home Scores for All MLB Teams",
       subtitle = "From 1947 (Racial Integration) to Oct. 2020",
       x = "Team",
       y = "Average Home Score")

```

# Models

$$ score = \beta_0 + \beta_1 home_i + \epsilon_i $$

```{r nfl model}

# Here, I make the NFL model using stan_glm() in order to predict the difference
# in scores between home and away games for the league, on the whole.

nfl_model_data_home <- nfl_scores_1966 %>%
  select(team_home, score_home) %>%
  mutate(home = 1) %>%
  rename(team = team_home,
         score = score_home)

nfl_model_data_away <- nfl_scores_1966 %>%
  select(team_away, score_away) %>%
  mutate(home = 0) %>%
  rename(team = team_away,
         score = score_away)

nfl_model_data <- full_join(nfl_model_data_home, nfl_model_data_away)
  

nfl_model <- stan_glm(score ~ home,
                      data = nfl_model_data,
                      refresh = 0)

print(nfl_model, digits = 4)

saveRDS(nfl_model, file = "nfl_model")

tbl_regression(nfl_model, intercept = TRUE) %>%
        as_gt() %>%
        fmt_number(columns = vars(estimate, std.error),
                   decimals = 4) %>%
        tab_header(title = "Regression of NFL Scores",
                   subtitle = "The Effect of Home Field on Score") %>%
        tab_source_note("Source: https://www.kaggle.com/tobycrabtree/nfl-scores-and-betting-data")

```

$$ score = \beta_0 + \beta_1 home_i + \beta_2 attendance_i + \beta_3 home_i * attendance_i + \epsilon_i $$

```{r mlb model}

# Here, I gather MLB attendance data.

mlb_attendance_raw <- read_csv("data/mlbscores/Teams.csv", 
                               col_types = cols(teamID = col_character())) %>%
  filter(yearID >= 1947) %>%
  filter(yearID != 2020) %>%
  select(yearID, Ghome, attendance, teamID, name) %>%
  mutate(avg_attendance = attendance / Ghome)

# Here, I further clean the mlb_scores dataset

mlb_scores_raw <- mlb_scores_1947 %>%
  select(date, season, home_team, away_team, home_score, away_score)

# Here, I sort out MLB team names.

mlb_attendance_names <- mlb_attendance_raw %>%
  distinct(teamID, name)

mlb_scores_names <- mlb_scores %>%
  distinct(home_team)

# Here, I edit mlb_attendance_raw to reflect the modern names of teams. I also
# create marker columns in mlb_attendance and mlb_scores for easy combining
# later on.

mlb_attendance <- mlb_attendance_raw %>%
  mutate(team = case_when(teamID == "BRO" ~ "LAD",
                          teamID == "BSN" ~ "ATL",
                          teamID == "CHA" ~ "CHW",
                          teamID == "NY1" ~ "SFG",
                          teamID == "NYA" ~ "NYY",
                          teamID == "PHA" ~ "OAK",
                          teamID == "SLA" ~ "BAL",
                          teamID == "WS1" ~ "MIN",
                          teamID == "ML1" ~ "ATL",
                          teamID == "KS1" ~ "OAK",
                          teamID == "LAN" ~ "LAD",
                          teamID == "WS2" ~ "TEX",
                          teamID == "NYN" ~ "NYM",
                          teamID == "CAL" ~ "ANA",
                          teamID == "KCA" ~ "KCR",
                          teamID == "MON" ~ "WSN",
                          teamID == "SDN" ~ "SDP",
                          teamID == "SE1" ~ "MIL",
                          teamID == "ML4" ~ "MIL",
                          teamID == "FLO" ~ "FLA",
                          teamID == "TBA" ~ "TBD",
                          teamID == "LAA" ~ "ANA",
                          teamID == "WAS" ~ "WSN",
                          teamID == "MIA" ~ "FLA",
                          TRUE ~ teamID)) %>%
  select(yearID, team, attendance, avg_attendance) %>%
  mutate(marker = str_c(yearID, team, sep = " "))

mlb_scores <- mlb_scores_raw %>%
  mutate(marker = str_c(season, home_team, sep = " "))

# Here, I combine both mlb_scores and mlb_attendance.

mlb_combined <- left_join(mlb_scores, mlb_attendance, by = "marker") %>%
  select(season, 
         home_team, 
         away_team, 
         home_score, 
         away_score, 
         avg_attendance) %>%
  mutate(home_team_name = case_when(home_team == "ANA" ~ "Los Angeles Angels",
                                    home_team == "ARI" ~ "Arizona Diamondbacks",
                                    home_team == "ATL" ~ "Atlanta Braves",
                                    home_team == "BAL" ~ "Baltimore Orioles",
                                    home_team == "BOS" ~ "Boston Red Sox",
                                    home_team == "CHC" ~ "Chicago Cubs",
                                    home_team == "CHW" ~ "Chicago White Sox",
                                    home_team == "CIN" ~ "Cincinnati Reds",
                                    home_team == "CLE" ~ "Cleveland Indians",
                                    home_team == "COL" ~ "Colorado Rockies",
                                    home_team == "DET" ~ "Detroit Tigers",
                                    home_team == "FLA" ~ "Miami Marlins",
                                    home_team == "HOU" ~ "Houston Astros",
                                    home_team == "KCR" ~ "Kansas City Royals",
                                    home_team == "LAD" ~ "Los Angeles Dodgers",
                                    home_team == "MIL" ~ "Milwaukee Brewers",
                                    home_team == "MIN" ~ "Minnesota Twins",
                                    home_team == "NYM" ~ "New York Mets",
                                    home_team == "NYY" ~ "New York Yankees",
                                    home_team == "OAK" ~ "Oakland Athletics",
                                    home_team == "PHI" ~ "Philadelphia Phillies",
                                    home_team == "PIT" ~ "Pittsburgh Pirates",
                                    home_team == "SDP" ~ "San Diego Padres",
                                    home_team == "SEA" ~ "Seattle Mariners",
                                    home_team == "SFG" ~ "San Francisco Giants",
                                    home_team == "STL" ~ "St. Louis Cardinals",
                                    home_team == "TBD" ~ "Tampa Bay Rays",
                                    home_team == "TEX" ~ "Texas Rangers",
                                    home_team == "TOR" ~ "Toronto Blue Jays",
                                    home_team == "WSN" ~ "Washington Nationals",
                                    TRUE ~ home_team)) %>%
  mutate(away_team_name = case_when(away_team == "ANA" ~ "Los Angeles Angels",
                                    away_team == "ARI" ~ "Arizona Diamondbacks",
                                    away_team == "ATL" ~ "Atlanta Braves",
                                    away_team == "BAL" ~ "Baltimore Orioles",
                                    away_team == "BOS" ~ "Boston Red Sox",
                                    away_team == "CHC" ~ "Chicago Cubs",
                                    away_team == "CHW" ~ "Chicago White Sox",
                                    away_team == "CIN" ~ "Cincinnati Reds",
                                    away_team == "CLE" ~ "Cleveland Indians",
                                    away_team == "COL" ~ "Colorado Rockies",
                                    away_team == "DET" ~ "Detroit Tigers",
                                    away_team == "FLA" ~ "Miami Marlins",
                                    away_team == "HOU" ~ "Houston Astros",
                                    away_team == "KCR" ~ "Kansas City Royals",
                                    away_team == "LAD" ~ "Los Angeles Dodgers",
                                    away_team == "MIL" ~ "Milwaukee Brewers",
                                    away_team == "MIN" ~ "Minnesota Twins",
                                    away_team == "NYM" ~ "New York Mets",
                                    away_team == "NYY" ~ "New York Yankees",
                                    away_team == "OAK" ~ "Oakland Athletics",
                                    away_team == "PHI" ~ "Philadelphia Phillies",
                                    away_team == "PIT" ~ "Pittsburgh Pirates",
                                    away_team == "SDP" ~ "San Diego Padres",
                                    away_team == "SEA" ~ "Seattle Mariners",
                                    away_team == "SFG" ~ "San Francisco Giants",
                                    away_team == "STL" ~ "St. Louis Cardinals",
                                    away_team == "TBD" ~ "Tampa Bay Rays",
                                    away_team == "TEX" ~ "Texas Rangers",
                                    away_team == "TOR" ~ "Toronto Blue Jays",
                                    away_team == "WSN" ~ "Washington Nationals",
                                    TRUE ~ away_team))

# Make RDS

saveRDS(mlb_combined, file = "mlb_combined")

# Here, I make the MLB model using stan_glm() in order to predict the difference
# in scores between home and away games for the league, on the whole.

# I mutate the "avg_attendance" column (divide it by 1000) to make the
# "attendance" column so that my analysis can be the change in score depending
# on every 1000+ fans are in attendance.

mlb_model_data_home <- mlb_combined %>%
  select(home_team, home_score, avg_attendance) %>%
  mutate(home = 1) %>%
  mutate(attendance = avg_attendance / 1000) %>%
  rename(team = home_team,
         score = home_score)

mlb_model_data_away <- mlb_combined %>%
  select(away_team, away_score, avg_attendance) %>%
  mutate(home = 0) %>%
  mutate(attendance = avg_attendance / 1000) %>%
  rename(team = away_team,
         score = away_score)

mlb_model_data <- full_join(mlb_model_data_home, mlb_model_data_away)

mlb_model_complex <- stan_glm(score ~ home + attendance + home * attendance,
                      data = mlb_model_data,
                      refresh = 0)

print(mlb_model, digits = 4)

saveRDS(mlb_model_complex, file = "mlb_model_complex")

mlb_model_simple <- stan_glm(score ~ home,
                       data = mlb_model_data,
                       refresh = 0)

print(mlb_model2, digits = 4)

saveRDS(mlb_model_simple, file = "mlb_model_simple")

```

```{r nba model}

# Here, I make the NBA model using stan_glm() in order to predict the difference
# in scores between home and away games for the league, on the whole.

nba_model_data_home <- nba_scores_2004 %>%
  select(home_team, pts_home) %>%
  mutate(home = 1) %>%
  rename(team = home_team,
         score = pts_home)

nba_model_data_away <- nba_scores_2004 %>%
  select(away_team, pts_away) %>%
  mutate(home = 0) %>%
  rename(team = away_team,
         score = pts_away)

nba_model_data <- full_join(nba_model_data_home, nba_model_data_away)

nba_model <- stan_glm(score ~ home,
                      data = nba_model_data,
                      refresh = 0)

print(nba_model, digits = 4)

saveRDS(nba_model, file = "nba_model")

```


Make dashboard of interactive interface with selections for different teams and different years.

Tab 1: Data Explanation
- This tab will also house interactive portion where you will be able to see average home scores of teams across the years.
Tab 2: Interesting Cases (maybe static plots, with paragraphs explaining what's interesting)
Tab 3: Models
- This tab will also house interactive portion where you will be able to determine the score margin for different teams.
Tab 4: MLB Model
Tab 4: About

Tab for each league
- Exploratory Data Visualization

Model: 
1. Not a causal model (no manipulation), only predictive model. Two conditions: home and away.
2. y axis is point difference of game. Outcome is point margin. stan_glm() usable.
- Cool graphic opportunities for this as well
- pivot_longer(): unit of analysis --> two rows: one row for the home team, and another from the away team. Almost exactly analagous to Week 9 lectures (control vs. treatment is analagous to home and away)
